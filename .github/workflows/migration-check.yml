name: Database Migration Validation

on:
  pull_request:
    paths:
      - 'app/models/**'
      - 'migrations/**'
      - 'requirements.txt'
  push:
    branches: [ main ]
    paths:
      - 'app/models/**'
      - 'migrations/**'

jobs:
  validate-migrations:
    runs-on: ubuntu-latest
    outputs:
      migration_changes: ${{ steps.migration_check.outputs.migration_changes }}
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Check for migration changes
        id: migration_check
        run: |
          # Check if there are changes to models or migrations
          if git diff --name-only HEAD~1 | grep -E "(app/models/|migrations/)" > /dev/null; then
            echo "migration_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“‹ Migration-related changes detected"
          else
            echo "migration_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No migration-related changes detected"
          fi

      - name: Validate migration consistency
        if: steps.migration_check.outputs.migration_changes == 'true'
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          FLASK_APP: app.py
        run: |
          echo "ðŸ” Validating migration consistency..."
          
          # Initialize fresh database
          flask db upgrade
          
          # Generate a new migration from current models
          flask db migrate -m "Test migration consistency" --rev-id test_consistency
          
          # Check if the generated migration is empty (no changes needed)
          MIGRATION_FILE=$(find migrations/versions -name "*test_consistency*.py" | head -1)
          
          if [ -f "$MIGRATION_FILE" ]; then
            # Check if migration has actual changes
            if grep -q "op\." "$MIGRATION_FILE"; then
              echo "âŒ Migration inconsistency detected!"
              echo "The database schema doesn't match the models."
              echo "Generated migration file: $MIGRATION_FILE"
              cat "$MIGRATION_FILE"
              exit 1
            else
              echo "âœ… Migration consistency validated - no schema drift detected"
              # Clean up test migration
              rm "$MIGRATION_FILE"
            fi
          else
            echo "âœ… No migration file generated - models are in sync"
          fi

      - name: Test migration rollback safety
        if: steps.migration_check.outputs.migration_changes == 'true'
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          FLASK_APP: app.py
        run: |
          echo "ðŸ”„ Testing migration rollback safety..."
          
          # Get current migration
          CURRENT_MIGRATION=$(flask db current)
          echo "Current migration: $CURRENT_MIGRATION"
          
          if [ -n "$CURRENT_MIGRATION" ] && [ "$CURRENT_MIGRATION" != "None" ]; then
            # Try to rollback one step
            echo "Testing rollback..."
            flask db downgrade -1
            
            # Try to upgrade back
            echo "Testing re-upgrade..."
            flask db upgrade
            
            echo "âœ… Migration rollback test passed"
          else
            echo "â„¹ï¸ No migrations to test rollback on"
          fi

      - name: Test migration with sample data
        if: steps.migration_check.outputs.migration_changes == 'true'
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          FLASK_APP: app.py
        run: |
          echo "ðŸ“Š Testing migration with sample data..."
          
          # Create sample data
          python -c "
          from app import create_app, db
          from app.models.user import User
          from app.models.project import Project
          import datetime
          
          app = create_app()
          with app.app_context():
              # Create test user
              user = User(
                  username='test_user',
                  email='test@example.com',
                  role='user'
              )
              user.set_password('test_password')
              db.session.add(user)
              
              # Create test project
              project = Project(
                  name='Test Project',
                  description='Test project for migration validation',
                  user_id=1
              )
              db.session.add(project)
              
              db.session.commit()
              print('âœ… Sample data created successfully')
          "
          
          # Verify data integrity after migration
          python -c "
          from app import create_app, db
          from app.models.user import User
          from app.models.project import Project
          
          app = create_app()
          with app.app_context():
              user_count = User.query.count()
              project_count = Project.query.count()
              print(f'Users: {user_count}, Projects: {project_count}')
              
              if user_count > 0 and project_count > 0:
                  print('âœ… Data integrity verified after migration')
              else:
                  print('âŒ Data integrity check failed')
                  exit(1)
          "

      - name: Generate migration report
        if: steps.migration_check.outputs.migration_changes == 'true'
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          FLASK_APP: app.py
        run: |
          echo "ðŸ“‹ Generating migration report..."
          
          # Get migration history
          echo "## Migration History" > migration_report.md
          echo "" >> migration_report.md
          flask db history --verbose >> migration_report.md
          
          # Get current schema info
          echo "" >> migration_report.md
          echo "## Current Schema" >> migration_report.md
          echo "" >> migration_report.md
          python -c "
          from app import create_app, db
          from sqlalchemy import inspect
          
          app = create_app()
          with app.app_context():
              inspector = inspect(db.engine)
              tables = inspector.get_table_names()
              print('### Tables:')
              for table in sorted(tables):
                  print(f'- {table}')
                  columns = inspector.get_columns(table)
                  for column in columns:
                      print(f'  - {column[\"name\"]}: {column[\"type\"]}')
          " >> migration_report.md
          
          cat migration_report.md

      - name: Upload migration report
        if: steps.migration_check.outputs.migration_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: migration-report
          path: migration_report.md

  comment-on-pr:
    runs-on: ubuntu-latest
    needs: validate-migrations
    if: github.event_name == 'pull_request' && always()
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Comment migration status on PR
        uses: actions/github-script@v7
        with:
          script: |
            const success = '${{ needs.validate-migrations.result }}' === 'success';
            const migrationChanges = '${{ needs.validate-migrations.outputs.migration_changes }}' === 'true';
            
            let commentBody = '## ðŸ—„ï¸ Database Migration Validation\n\n';
            
            if (migrationChanges) {
              if (success) {
                commentBody += 'âœ… **Migration validation passed!**\n\n';
                commentBody += '**Completed checks:**\n';
                commentBody += '- âœ… Migration consistency validation\n';
                commentBody += '- âœ… Rollback safety test\n';
                commentBody += '- âœ… Data integrity verification\n\n';
                commentBody += '**The database migrations are safe to apply.** ðŸš€\n';
              } else {
                commentBody += 'âŒ **Migration validation failed!**\n\n';
                commentBody += '**Issues detected:**\n';
                commentBody += '- Migration consistency problems\n';
                commentBody += '- Rollback safety issues\n';
                commentBody += '- Data integrity concerns\n\n';
                commentBody += '**Please review the migration files and fix the issues before merging.** âš ï¸\n';
              }
            } else {
              commentBody += 'â„¹ï¸ **No migration-related changes detected.**\n\n';
              commentBody += 'This PR does not modify database models or migrations.\n';
            }
            
            commentBody += '\n---\n*This comment was automatically generated by the Migration Validation workflow.*';
            
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Database Migration Validation')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody,
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentBody,
              });
            }
