# ğŸš€ Automatic HTTPS Setup

## One-Command HTTPS Startup

HTTPS is now **completely automatic**! Just run one command and everything is configured:

### Windows
```cmd
start-https.bat
```

### Linux/Mac
```bash
bash start-https.sh
```

That's it! ğŸ‰

---

## What Happens Automatically

When you run the startup script:

1. âœ… **Detects your local IP** (e.g., 192.168.1.100)
2. âœ… **Creates nginx HTTPS configuration** automatically
3. âœ… **Generates SSL certificates** (init container runs once)
4. âœ… **Updates security settings** to strict mode
5. âœ… **Starts all services** with HTTPS enabled

**No manual steps required!**

---

## Two Certificate Options

### Option 1: Self-Signed Certificates (Default)
- âœ… Works immediately, zero setup
- âœ… Fully functional HTTPS
- âš ï¸ Browser shows security warning (safe to click through)

**When to use:** Quick testing, development

### Option 2: mkcert (Trusted Certificates)
- âœ… No browser warnings!
- âœ… Trusted by all browsers
- ğŸ“‹ Requires one-time mkcert installation

**When to use:** Cleaner experience, demos, regular development

---

## Quick Start

### First Time Setup

**1. Create .env file:**
```bash
cp env.example .env
# Edit .env with your settings
```

**2. Start with HTTPS:**

**Windows:**
```cmd
start-https.bat
```

**Linux/Mac:**
```bash
bash start-https.sh
```

**3. Choose certificate method when prompted:**
- Press `1` for self-signed (default)
- Press `2` for mkcert (if installed)

**4. Access your app:**
```
https://localhost
https://192.168.1.100  (your actual IP)
```

---

## Self-Signed Certificates (Option 1)

### What You'll See
Browser will show: "Your connection is not private"

### How to Proceed
1. Click **"Advanced"**
2. Click **"Proceed to localhost (unsafe)"**
3. That's it! You're in.

### Why It's Safe
- Certificates are generated by YOU
- Traffic is encrypted
- Warning is just because it's self-signed
- Perfect for development

---

## mkcert Certificates (Option 2)

### Prerequisites
**Install mkcert first:**

**Windows:**
```powershell
choco install mkcert
```

**macOS:**
```bash
brew install mkcert
```

**Linux:**
```bash
# See HTTPS_MKCERT_GUIDE.md
```

### One-Time CA Installation

After first startup with mkcert:

1. **Find the CA certificate:**
   ```
   nginx/ssl/rootCA.pem
   ```

2. **Install it:**

   **Windows:**
   - Double-click `rootCA.pem`
   - Install to "Trusted Root Certification Authorities"
   - Restart browser

   **macOS:**
   - Double-click `rootCA.pem`
   - Add to Keychain
   - Mark as "Always Trust"

   **Linux:**
   ```bash
   sudo cp nginx/ssl/rootCA.pem /usr/local/share/ca-certificates/mkcert.crt
   sudo update-ca-certificates
   ```

3. **Restart browser**

4. **Access app** - No warnings! âœ…

---

## How It Works

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  start-https    â”‚  â† You run this
â”‚     script      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Init Containerâ”‚  â† Generates certificates (runs once)
â”‚   (certgen)     â”‚     â€¢ Checks if certs exist
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â€¢ Creates them if missing
         â”‚              â€¢ Self-signed or mkcert
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nginx (HTTPS)  â”‚  â† Reverse proxy with SSL
â”‚  Port 443       â”‚     â€¢ Terminates SSL
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â€¢ Proxies to app
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TimeTracker    â”‚  â† Your application
â”‚  App (HTTP)     â”‚     â€¢ Runs on port 8080
â”‚  Port 8080      â”‚     â€¢ Behind nginx
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Certificate Generation

The `certgen` init container:
- Runs before nginx starts
- Checks for existing certificates in `nginx/ssl/`
- If missing, generates new ones
- Exits (runs only once)
- nginx starts after successful completion

### Persistence

Certificates are stored in `nginx/ssl/` on your host machine:
- Persists across container restarts
- Regenerated only if deleted
- Valid for 10 years

---

## File Structure

After automatic startup:

```
TimeTracker/
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ conf.d/
â”‚   â”‚   â””â”€â”€ https.conf           # Auto-generated nginx config
â”‚   â””â”€â”€ ssl/
â”‚       â”œâ”€â”€ cert.pem             # SSL certificate
â”‚       â”œâ”€â”€ key.pem              # Private key
â”‚       â””â”€â”€ rootCA.pem           # CA cert (mkcert only)
â”œâ”€â”€ docker-compose.yml           # Base config
â”œâ”€â”€ docker-compose.https-auto.yml    # HTTPS with self-signed
â”œâ”€â”€ docker-compose.https-mkcert.yml  # HTTPS with mkcert
â”œâ”€â”€ start-https.sh               # Auto-start script (Linux/Mac)
â”œâ”€â”€ start-https.bat              # Auto-start script (Windows)
â””â”€â”€ .env                         # Config (auto-updated)
```

---

## Commands

### Start with HTTPS (Automatic)
```bash
bash start-https.sh     # Linux/Mac
start-https.bat         # Windows
```

### Start with HTTPS (Manual)
```bash
# Self-signed certificates
docker-compose -f docker-compose.yml -f docker-compose.https-auto.yml up -d

# mkcert certificates (if mkcert installed)
docker-compose -f docker-compose.yml -f docker-compose.https-mkcert.yml up -d
```

### View Logs
```bash
docker-compose logs -f
docker-compose logs nginx
docker-compose logs certgen
```

### Stop Services
```bash
docker-compose down
```

### Regenerate Certificates
```bash
# Delete existing certs
rm -rf nginx/ssl/*

# Restart - new certs will be generated
bash start-https.sh
```

---

## Environment Variables

After automatic setup, your `.env` will include:

```bash
# HTTPS Security Settings (auto-configured)
WTF_CSRF_SSL_STRICT=true
SESSION_COOKIE_SECURE=true
CSRF_COOKIE_SECURE=true
```

**These settings:**
- âœ… Enable strict CSRF protection
- âœ… Require HTTPS for cookies
- âœ… Fix all CSRF cookie issues
- âœ… Provide production-grade security

---

## Troubleshooting

### nginx Won't Start

**Check if certificates exist:**
```bash
ls -la nginx/ssl/
```

**Should see:**
- `cert.pem`
- `key.pem`

**If missing, check certgen logs:**
```bash
docker-compose logs certgen
```

### Browser Still Shows Warning (mkcert)

**CA not installed or browser not restarted:**
1. Install `nginx/ssl/rootCA.pem` (see instructions above)
2. Completely close and restart browser
3. Clear browser cache

### Different IP Address

**Update and restart:**
```bash
export HOST_IP=192.168.1.XXX  # Your actual IP
bash start-https.sh
```

### Port 443 Already in Use

**Find what's using it:**
```bash
# Windows
netstat -ano | findstr :443

# Linux/Mac
lsof -i :443
```

**Stop the conflicting service or change port in nginx config**

---

## Access from Other Devices

### Using Self-Signed Certificates
1. Access `https://192.168.1.100` from device
2. Click through security warning
3. Done!

### Using mkcert Certificates
1. Copy `nginx/ssl/rootCA.pem` to device
2. Install as trusted CA (see device-specific instructions)
3. Access `https://192.168.1.100`
4. No warnings! âœ…

---

## Production Deployment

For production with a real domain, use Let's Encrypt:
- See `docs/HTTPS_SETUP_GUIDE.md` for Caddy (automatic)
- Or use Traefik, nginx + certbot

---

## Summary

### ğŸ‰ What You Get

âœ… **One-command setup** - `bash start-https.sh`  
âœ… **Automatic certificate generation**  
âœ… **Auto-configuration** of nginx and security settings  
âœ… **Choice of certificate types**  
âœ… **Persistent certificates** across restarts  
âœ… **No manual steps** for basic setup  

### ğŸš€ Quick Reference

```bash
# Start everything with HTTPS
bash start-https.sh

# Access
https://localhost
https://192.168.1.100

# View logs
docker-compose logs -f

# Stop
docker-compose down
```

**That's it! Enjoy automatic HTTPS! ğŸ”’**

